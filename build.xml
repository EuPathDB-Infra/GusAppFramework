<project name="GUS" default="Installation" basedir=".">

  <!-- oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooooo  Dependencies  oooooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->

  <target name="CBIL-Installation">
    <ant antfile="../CBIL/build.xml" target="CBIL-Installation">
      <property name="project" value="CBIL"/>
      <property name="version" value="2.1.2"/>
    </ant>
  </target>  

  <!-- oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooooo  Distributable  ooooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->

  <target name="GUS-Distributable" depends="ProjectTree ">

    <copy todir="${targetDir}">
      <fileset dir="${projectsDir}" >
        <exclude name="**/CVS/*" />
      </fileset>
    </copy>  
  </target>  

  <!-- oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooooo  Installation  oooooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->
 
  <target name="GUS-Installation" depends="CBIL-Installation,
                                           GUS/Common-Installation, 
                                           GUS/DBAdmin-Installation, 
                                           GUS/GOPredict-Installation, 
                                           GUS/Model-Installation, 
                                           GUS/ObjRelP-Installation, 
                                           GUS/Pipeline-Installation, 
                                           GUS/PluginMgr-Installation, 
                                           GUS/SchemaBrowser-Installation"> 
    <ant target="defaultProjectInstall"/>
  </target>

  <target name="GUS/Common-Installation" depends="ProjectTree">
    <ant target="defaultComponentInstall">
      <property name="project" value="GUS"/>
      <property name="component" value="Common"/>
    </ant>
  </target>  

  <target name="GUS/DBAdmin-Installation" depends="ProjectTree">
    <ant target="defaultComponentInstall">
      <property name="project" value="GUS"/>
      <property name="component" value="DBAdmin"/>
      
    </ant>
  </target>  


  <target name="GUS/GOPredict-Installation" depends="ProjectTree">
    <ant target="defaultComponentInstall">
      <property name="project" value="GUS"/>
      <property name="component" value="GOPredict"/>
    </ant>
  </target>
  
  

  <target name="GUS/Model-Installation" depends="ProjectTree, 
                                                 PerlModel,
                                                 JavaModel,
                                                 schema">
    <ant target="defaultComponentInstall">
      <property name="project" value="GUS"/>
      <property name="component" value="Model"/>
     </ant>

  </target>  

  <target name="JavaModel" depends = "checkJavaObjects,
                                     javaGeneratedModel,
	                             javaManuallyEditedModel">
    <echo message="Starting target: JavaModel"/>
  </target>


  <target name="PerlModel" depends = "checkPerlObjects,
                                      perlGeneratedModel,
                                      perlManuallyEditedModel"/>
                                     
  <target name="javaGeneratedModel" unless="javaObjectsAlreadyGenerated"
                                    depends="ProjectTree, GUS/ObjRelJ-Installation">
     <echo message="starting target: javaGeneratedModel"/>
     
     <mkdir dir="${projectsDir}/GUS/Model/src/java/org/gusdb/model/Core"/>
     <mkdir dir="${projectsDir}/GUS/Model/src/java/org/gusdb/model/DoTS"/>
     <mkdir dir="${projectsDir}/GUS/Model/src/java/org/gusdb/model/RAD3"/>
     <mkdir dir="${projectsDir}/GUS/Model/src/java/org/gusdb/model/SRes"/>
     <mkdir dir="${projectsDir}/GUS/Model/src/java/org/gusdb/model/TESS"/>
     
      <delete>
        <fileset dir="${projectsDir}/GUS/Model/src/java/org/gusdb/model/Core" includes="*.java, *.class"/>
        <fileset dir="${projectsDir}/GUS/Model/src/java/org/gusdb/model/DoTS" includes="*.java, *.class"/>
        <fileset dir="${projectsDir}/GUS/Model/src/java/org/gusdb/model/RAD3" includes="*.java, *.class"/>
        <fileset dir="${projectsDir}/GUS/Model/src/java/org/gusdb/model/SRes" includes="*.java, *.class"/>
        <fileset dir="${projectsDir}/GUS/Model/src/java/org/gusdb/model/TESS" includes="*.java, *.class"/>
      </delete>
      <echo message="generating java objects"/>

      <exec executable="generateGusObjects" 
            failonerror="true">
        <arg value="--javaOrPerl=java"/>
      </exec>

   </target>

  <target name="javaManuallyEditedModel" depends="ProjectTree">

        <mkdir dir="${projectsDir}/GUS/Model/src/java/org/gusdb/model/hand_edited/Core"/>
        <mkdir dir="${projectsDir}/GUS/Model/src/java/org/gusdb/model/hand_edited/DoTS"/>
        <mkdir dir="${projectsDir}/GUS/Model/src/java/org/gusdb/model/hand_edited/SRes"/>
        <mkdir dir="${projectsDir}/GUS/Model/src/java/org/gusdb/model/hand_edited/TESS"/>
        <mkdir dir="${projectsDir}/GUS/Model/src/java/org/gusdb/model/hand_edited/RAD3"/>

        <copy todir="${projectsDir}/GUS/Model/src/java/org/gusdb/model/DoTS" overwrite="true">
           <fileset dir="${projectsDir}/GUS/Model/src/java/org/gusdb/model/hand_edited/DoTS"/>
           <mapper type="glob" from="*.java.man" to="*.java"/>
        </copy>
        <copy todir="${projectsDir}/GUS/Model/src/java/org/gusdb/model/SRes" overwrite="true">
           <fileset dir="${projectsDir}/GUS/Model/src/java/org/gusdb/model/hand_edited/SRes"/>
           <mapper type="glob" from="*.java.man" to="*.java"/>
        </copy>
        <copy todir="${projectsDir}/GUS/Model/src/java/org/gusdb/model/Core" overwrite="true">
           <fileset dir="${projectsDir}/GUS/Model/src/java/org/gusdb/model/hand_edited/Core"/>
           <mapper type="glob" from="*.java.man" to="*.java"/>
        </copy>
        <copy todir="${projectsDir}/GUS/Model/src/java/org/gusdb/model/TESS" overwrite="true">
           <fileset dir="${projectsDir}/GUS/Model/src/java/org/gusdb/model/hand_edited/TESS"/>
           <mapper type="glob" from="*.java.man" to="*.java"/>
        </copy>
        <copy todir="${projectsDir}/GUS/Model/src/java/org/gusdb/model/RAD3" overwrite="true">
           <fileset dir="${projectsDir}/GUS/Model/src/java/org/gusdb/model/hand_edited/RAD3"/>
           <mapper type="glob" from="*.java.man" to="*.java"/>
        </copy>
  </target>
	                                 
  <target name="perlGeneratedModel" unless="perlObjectsAlreadyGenerated" 
                                    depends="ProjectTree,
                                    GUS/ObjRelP-Installation">

     <mkdir dir="${projectsDir}/GUS/Model/lib/perl/Core"/>
     <mkdir dir="${projectsDir}/GUS/Model/lib/perl/DoTS"/>
     <mkdir dir="${projectsDir}/GUS/Model/lib/perl/RAD3"/>
     <mkdir dir="${projectsDir}/GUS/Model/lib/perl/SRes"/>
     <mkdir dir="${projectsDir}/GUS/Model/lib/perl/TESS"/>

     <mkdir dir="${targetDir}/lib/perl/GUS/Model/Core"/>
     <mkdir dir="${targetDir}/lib/perl/GUS/Model/DoTS"/>
     <mkdir dir="${targetDir}/lib/perl/GUS/Model/RAD3"/>
     <mkdir dir="${targetDir}/lib/perl/GUS/Model/SRes"/>
     <mkdir dir="${targetDir}/lib/perl/GUS/Model/TESS"/>

     <delete>
       <fileset dir="${projectsDir}/GUS/Model/lib/perl/Core" includes="*.pm"/>
       <fileset dir="${projectsDir}/GUS/Model/lib/perl/DoTS" includes="*.pm"/>
       <fileset dir="${projectsDir}/GUS/Model/lib/perl/RAD3" includes="*.pm"/>
       <fileset dir="${projectsDir}/GUS/Model/lib/perl/SRes" includes="*.pm"/>
       <fileset dir="${projectsDir}/GUS/Model/lib/perl/TESS" includes="*.pm"/>
       <fileset dir="${targetDir}/lib/perl/GUS/Model/Core" includes="*.pm"/>
       <fileset dir="${targetDir}/lib/perl/GUS/Model/DoTS" includes="*.pm"/>
       <fileset dir="${targetDir}/lib/perl/GUS/Model/RAD3" includes="*.pm"/>
       <fileset dir="${targetDir}/lib/perl/GUS/Model/SRes" includes="*.pm"/>
       <fileset dir="${targetDir}/lib/perl/GUS/Model/TESS" includes="*.pm"/>
     </delete>
     <echo message="generating Perl Objects"/>

     <exec executable="generateGusObjects" 
           failonerror="true">
       <arg value="--javaOrPerl=perl"/>
     </exec>
   </target>  

   <target name="perlManuallyEditedModel" depends="ProjectTree,
                                      GUS/ObjRelP-Installation">

     <copy todir="${projectsDir}/GUS/Model/lib/perl/Core">
       <fileset dir="${projectsDir}/GUS/Model/lib/perl/Core"/>
       <mapper type="glob" from="*.pm.man" to="*.pm"/>
     </copy>

     <copy todir="${projectsDir}/GUS/Model/lib/perl/DoTS">
       <fileset dir="${projectsDir}/GUS/Model/lib/perl/DoTS"/>
       <mapper type="glob" from="*.pm.man" to="*.pm"/>
     </copy>

     <copy todir="${projectsDir}/GUS/Model/lib/perl/RAD3">
       <fileset dir="${projectsDir}/GUS/Model/lib/perl/RAD3"/>
       <mapper type="glob" from="*.pm.man" to="*.pm"/>
     </copy>

     <copy todir="${projectsDir}/GUS/Model/lib/perl/SRes">
       <fileset dir="${projectsDir}/GUS/Model/lib/perl/SRes"/>
       <mapper type="glob" from="*.pm.man" to="*.pm"/>
     </copy>

     <copy todir="${projectsDir}/GUS/Model/lib/perl/TESS">
       <fileset dir="${projectsDir}/GUS/Model/lib/perl/TESS"/>
       <mapper type="glob" from="*.pm.man" to="*.pm"/>
     </copy>

   </target>  

  <target name="checkPerlObjects">
    <uptodate property="perlObjectsAlreadyGenerated" 
              targetfile="${projectsDir}/GUS/Model/lib/perl/generated">
       <srcfiles dir= "${projectsDir}/GUS/Model/schema" includes="VERSION"/>
       <srcfiles dir= "${projectsDir}/GUS/Model/data" includes="modelSpecialCases.txt"/>
    </uptodate>
  </target>

  <target name="checkJavaObjects">
    <uptodate property="javaObjectsAlreadyGenerated" 
              targetfile="${projectsDir}/GUS/Model/src/java/org/gusdb/model/generated">
       <srcfiles dir= "${projectsDir}/GUS/Model/schema" includes="VERSION"/>
       <srcfiles dir= "${projectsDir}/GUS/Model/data" includes="modelSpecialCases.txt"/>
    </uptodate>
  </target>
 

  <target name="schemaConfigFile">
    <ant target="configFile">
      <property name="cFileName" value="schema.prop"/>
      <property name="cFileSrcDir" value="${projectsDir}/GUS/Model/config"/>
    </ant>
  </target>

  <target name="schema" depends="schemaConfigFile">
    <mkdir dir="${targetDir}/schema"/>
    <dependset>
       <srcfilelist dir="${targetDir}/config" files="schema.prop"/>
       <targetfileset dir="${targetDir}/schema" includes="**/*"/>
    </dependset>
    <copy todir="${targetDir}/schema">
      <fileset dir="${projectsDir}/GUS/Model/schema" >
        <include name="**"/>
        <exclude name="**/CVS/*" />
      </fileset>
      <filterset>
        <filtersfile file="${targetDir}/config/schema.prop"/>
      </filterset>
    </copy>
  </target>  

   <target name="GUS/ObjRelP-Installation" depends="ProjectTree">
    <ant target="defaultComponentInstall">
      <property name="project" value="GUS"/>
      <property name="component" value="ObjRelP"/>
    </ant>

    <!-- Hack to do replace immediately after ObjRelP is installed -->
    <!-- so objects can be generated without breaking              -->

    <replace dir="${targetDir}/bin" 
             propertyFile="${targetDir}/config/install.prop" > 
      <include name="**/*" />
      <replacefilter token="@perl@" property="perl"/>
    </replace> 

    <!-- because the replace task clobbers permissions.  see ant bug #5661 -->
    <chmod perm="+x">
      <fileset dir="${targetDir}/bin"/>
    </chmod>

  </target>  


  <target name="GUS/ObjRelJ-Installation" depends="ProjectTree">

    <rmic base="${projectsDir}/GUS/ObjRelJ/src/java"
	 classname="org.gusdb.objrelj.RemoteJDBCServer">
        <classpath>
           <fileset dir="${targetDir}/lib/java/">
              <include name="*.jar"/>
           </fileset>
        </classpath>     
     </rmic>  

    
    <rmic base="${projectsDir}/GUS/ObjRelJ/src/java"
	 classname="org.gusdb.objrelj.RemoteDatabaseConnection">
	<classpath>
           <fileset dir="${targetDir}/lib/java/">
              <include name="*.jar"/>
           </fileset>
        </classpath>     
     </rmic>    
  
   <move todir="${projectsDir}/GUS/ObjRelJ/classes/org/gusdb/objrelj">
	 <fileset dir="${projectsDir}/GUS/ObjRelJ/src/java/org/gusdb/objrelj">
            <include name="*.class"/>
         </fileset>
   </move>

   <ant target="defaultComponentInstall">
      <property name="project" value="GUS"/>
      <property name="component" value="ObjRelJ"/>
    </ant>
    
  </target>



  <target name="GUS/Pipeline-Installation" depends="ProjectTree">
    <ant target="defaultComponentInstall">
      <property name="project" value="GUS"/>
      <property name="component" value="Pipeline"/>
    </ant>
  </target>  

  <target name="GUS/PluginMgr-Installation" depends="GUS/ObjRelP-Installation,
                                                     ProjectTree">
    <ant target="defaultComponentInstall">
      <property name="project" value="GUS"/>
      <property name="component" value="PluginMgr"/>
    </ant>
  </target>
  
  <target name="GUS/SchemaBrowser-Installation" depends="ProjectTree">
    <ant target="defaultComponentInstall">
      <property name="project" value="GUS"/>
      <property name="component" value="SchemaBrowser"/>
    </ant>
  </target>  

  <target name="GUS/WebDevKit-Installation" depends="ProjectTree">
    <ant target="defaultComponentInstall">
      <property name="project" value="GUS"/>
      <property name="component" value="WebDevKit"/>
    </ant>
  </target>  


  <!-- oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooo  Web Installation  oooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->

  <target name="GUS-WebInstallation" depends="GUS/DBAdmin-WebInstallation, 
                                              GUS/SchemaBrowser-WebInstallation, 
                                              GUS/WebDevKit-WebInstallation "/>


  <target name="GUS/DBAdmin-WebInstallation" depends="ProjectTree">
    <ant target="defaultWebComponentInstall">
       <property name="project" value="GUS"/>
       <property name="component" value="DBAdmin"/>
    </ant>
  </target>  

  <target name="GUS/SchemaBrowser-WebInstallation" depends="ProjectTree">
    <ant target="defaultWebComponentInstall">
      <property name="project" value="GUS"/>
      <property name="component" value="SchemaBrowser"/>
    </ant>
  </target>  

  <target name="GUS/WebDevKit-WebInstallation" depends="ProjectTree">
    <ant target="defaultWebComponentInstall">
      <property name="project" value="GUS"/>
      <property name="component" value="WebDevKit"/>
  </ant>
  </target>  


  <!-- oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooooo  ProjectTree  ooooooooooooooooooooooooooo -->
  <!-- oooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooo -->

  <target name="ProjectTree" if="${checkout}">
    <ant target="projectCheckOut"/>
  </target>  

</project>

