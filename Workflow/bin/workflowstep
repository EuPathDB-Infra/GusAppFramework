#!/usr/bin/perl

use lib "$ENV{GUS_HOME}/lib/perl";

use strict;
use GUS::Workflow::WorkflowHandle;
use GUS::Workflow::WorkflowStepPilot;

# these should be imported from someplace, not duplicated here
my $READY = 'READY';      # my parents are not done yet  -- default state
my $ON_DECK = 'ON_DECK';  # my parents are done, but there is no slot for me
my $FAILED = 'FAILED';
my $DONE = 'DONE';
my $RUNNING = 'RUNNING';

&usage unless (scalar(@ARGV) >= 3);

my $homeDir = $ARGV[0];
my $stepNamePattern = $ARGV[1];
my $offline;
my $state;
my $list;
if ($ARGV[2] eq '-l') {
    $list = 1;
} elsif ($ARGV[2] eq 'offline' || $ARGV[2] eq 'online') {
  $offline = $ARGV[2];
  $state = $ARGV[3];
} else {
  $state = $ARGV[2]
}
&usage unless ($list || $offline || ($state eq 'kill' || $state eq 'ready'));

my $workflow = GUS::Workflow::WorkflowHandle->new($homeDir);

my $stepNames = $workflow->getStepNamesFromPattern($stepNamePattern);

foreach my $stepName (@$stepNames) {

    if ($list) {
	print "$stepName\n";
	next;
    }

    my $step = GUS::Workflow::WorkflowStepPilot->new($stepName, $workflow);

    if ($state eq 'ready') {
	$step->pilotSetReady();
    } elsif ($state eq 'kill') {
	$step->pilotKill();
    }

    if ($offline) {
	$step->pilotSetOffline($offline);
    }
}

sub usage {
    print "

Change the state and/or offline status of the workflow steps whose name match the provided pattern.

Usage: workflowstep -h workflow_home_dir stepname_pattern [-l | [offline|online] [ready|kill]]

Where:
  -h                   - workflow home dir
  stepname_pattern     - wildcard pattern using '%' as a wildcard (Oracle
                         syntax) to specify  one or more steps to change.
                         EG, %.runBlast
  -l                   - list mode: don't change any steps, just list the
                         names that match the pattern

Allowed state changes are:
  $FAILED  --> ready
  $RUNNING --> kill

Offline status may not be changed when the step is $RUNNING

Examples
  % workflowstep workflow_dir stepname_pattern -l

  % workflowstep workflow_dir stepname_pattern kill

  % workflowstep workflow_dir stepname_pattern online

  % workflowstep workflow_dir stepname_pattern offline ready
";
    exit(1);
}




