#!@PERL@

# ----------------------------------------------------------
# schemaBrowser.pl
#
# Created: Tue May 16 12:20:01 EDT 2000
#
# Jonathan Crabtree
#
# $Revision$ $Date$ $Author$
# ----------------------------------------------------------

use strict;
require 'cgi_lib.perl';
use lib "@GUS_HOME@/lib/perl";
use GUS::ObjRelP::DbiDatabase;
require GUS::SchemaBrowser::SchemaBrowser;

# ----------------------------------------------------------
# Configuration
# ----------------------------------------------------------

my $url = '@CGI_BIN_URL@/schemaBrowser.pl';

# ----------------------------------------------------------
# Main
# ----------------------------------------------------------

$| = 1;
my %rq = &get_request();

$rq{'db'} = '*' if (not(defined($rq{'db'})));
$rq{'table'} = '*' if (not(defined($rq{'table'})));

my $logins = {

    # Oracle development databases on erebus
    #
    'GUSdev' => 
    {login => 'gusdevreadonly', 
     password => 's7fp4erv',
     dbi_str => 'dbi:Oracle:host=erebus.pcbi.upenn.edu;sid=gusdev',
     tableinfo => 1,
     documentation => 0,
     description => 'The "Genomics Unified Schema" development database (Oracle 8i).',
     },
    'RADdev' => 
    {login => 'raddevreadonly', 
     password => 'pt5sz73',
     dbi_str => 'dbi:Oracle:host=erebus.pcbi.upenn.edu;sid=gusdev',
     tableinfo => 1,
     documentation => 0,
     description => 'RNA Abundance Database (RAD) development database (Oracle 8i).',
     },

    # Oracle production databases on nemesis
    #
    'GUS' => 
    {login => 'GUSreadonly', 
     password => 's7fp4erv',
     dbi_str => 'dbi:Oracle:host=nemesis.pcbi.upenn.edu;sid=gus',
     tableinfo => 1,
     documentation => 0,
     description => 'The "Genomics Unified Schema" production database (Oracle 8i).',
     },
    'RAD' => 
    {login => 'RADreadonly', 
     password => 'pt5sz73',
     dbi_str => 'dbi:Oracle:host=nemesis.pcbi.upenn.edu;sid=gus',
     tableinfo => 1,
     documentation => 0,
     description => 'RNA Abundance Database (RAD) production database (Oracle 8i).',
     },

};

# Order in which to display databases for browsing.
#
my $loginsOrder = ['GUS', 'GUSdev', 'RAD', 'RADdev', 'GUSdev (Sybase)',
		   'rad (Sybase)', 'rad2 (Sybase)', 'image (Sybase)'];

# Look up the login for this database
#
my $login = $$logins{$rq{'db'}};

# Unsupported database
#
if ((not defined($login)) && ($rq{'db'} ne '*')) {
    print "Content-type:text/html\n\n";
    print "<HTML><TITLE>allgenes.org | Schema browser | Error</TITLE>";
    print "<BODY BGCOLOR=\"#ffffff\">\n";
    print $rq{'db'}, " is not a supported database.\n";
    &pageFooter();
    print "</BODY></HTML>\n";
    exit(0);
}

my $db;
my $hasTableInfo;
my $hasDocumentation;

if ($rq{'db'} ne '*') {
    $db = new GUS::ObjRelP::DbiDatabase($$login{'dbi_str'}, $$login{'login'}, $$login{'password'}, 0, 1, undef, 'core');
    $hasTableInfo = $$login{'tableinfo'};
}

my $browser = GUS::SchemaBrowser::SchemaBrowser->new($url, \&pageHeader, \&pageFooter, $db, $hasTableInfo);

$browser->generatePage({db => $rq{'db'}, 
			table => $rq{'table'}, 
			path => $rq{'path'}, 
			title => "allgenes.org | Schema browser | ",
			logins => $logins ,
			loginsOrder => $loginsOrder});

# ----------------------------------------------------------
# Subroutines
# ----------------------------------------------------------

sub pageHeader {
    my($self, $args) = @_;

    my $title = $args->{'title'};

    if ($args->{'table'} eq '*') {
	$title .= "All tables and views";
    } else {
	$title .= $args->{'db'} . ".." . $args->{'table'};
    }

    print "<HTML><TITLE>$title</TITLE>\n";
    print "<BODY BGCOLOR=\"#ffffff\">\n";
}

sub pageFooter {
    print '<TABLE cellpadding="0" width="100%" border="0" cellspacing="0">';
    print '<TR BGCOLOR="#986666"><TD COLSPAN="2">';
    print '<IMG SRC="@HTDOCS_URL@/images/dred1.gif" WIDTH="1" HEIGHT="2"></TD></TR>';
    print '<TR BGCOLOR="#ffffff"><TD COLSPAN="2">';
    print '<IMG SRC="@HTDOCS_URL@/images/white1.gif" WIDTH="1" HEIGHT="2"></TD></TR>';
    print "<TR>";
    print '<TD><IMG SRC="@HTDOCS_URL@/images/copyright.gif"></TD>';
    print '<TD ALIGN="right"><FONT SIZE="-1"><A HREF="mailto:webmaster@allgenes.org">';
    print 'webmaster@allgenes.org</A></FONT></TD>';
    print '</TR></TABLE><BR>';
}
