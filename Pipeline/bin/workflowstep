#!/usr/bin/perl

use DBI;
use GUS::Pipeline::Workflow;

my $stepName = $ARGV[0];
my $metaConfigFile = $ARGV[1];
my $state = $ARGV[2];

if (scalar($ARGV) != 3) {
    usage();
}

my $workflow = GUS::Pipeline::Workflow->new($metaConfigFile);

my $step = workflow->getStep($stepName);

if ($state eq 'RUNSTEP') {
    my $pid = $$;

    my $status = $step->runInWrapper($pid);

    exit($status);
}

else {
    usage() unless grep(/$state/, 'READY', 'FAILED', 'DO_NOT_RUN');
    $step->forceState($state);
}

sub usage {
    print "
usage: workflowstep stepname metaconfigfile state

allowed states are:
  READY 
  FAILED
  DO_NOT_RUN

allowed transitions are:
  DO_NOT_RUN --> READY
  FAILED     --> READY
  RUNNING    --> FAILED
  READY      --> DO_NOT_RUN
  ON_DECK    --> DO_NOT_RUN
";
    exit(1);
}




