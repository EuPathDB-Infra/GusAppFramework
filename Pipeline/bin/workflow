#!/usr/bin/perl

use strict;
use lib "$ENV{GUS_HOME}/lib/perl";
use GUS::Pipeline::Workflow::Workflow;

my $metaConfigFile = shift @ARGV;
my $numStepsAllowed;
my @report;
if ($ARGV[0] =~ /\d+/) {
  $numStepsAllowed = $ARGV[0];
} else {
  @report = @ARGV;
}

&usage unless $metaConfigFile && ($numStepsAllowed || scalar(@report));

my $workflow = GUS::Pipeline::Workflow::Workflow->new($metaConfigFile);

if (scalar(@report)) {
    if ($report[0] eq 'state') {
	$workflow->reportState();
    } else {
	$workflow->reportSteps(\@report);
    }
} else {
    $workflow->run($numStepsAllowed);
}

sub usage {
    print "

Run a workflow, or, print a report about a workflow.


Usage:  workflow workflow_dir <allowed_running_steps | report_options>

Where:
  workflow_dir:           the workflow's home directory.  see below
  allowed_running_steps:  number of steps that can run simultaneously
  report_options:         either 'state' which reports a brief summary of workflow state
                          or, a list of desired step states to report, eg 'RUNNING FAILED'

Supply either allowed_running_steps or report_options (not both).  If report_options
is set, don't run, just print a report.

Home dir must contain the following:
  config/
    workflow.prop
    workflow.xml
    steps.prop
    stepsGlobal.prop
    resources.prop

Examples:

 run a workflow:
   % workflow workflow_dir 3

 quick report of workflow state
   % workflow workflow_dir -q

 print steps report.  optionally limit to steps in particular states
   % workflow workflow_dir -s
   % workflow workflow_dir -s FAILED RUNNING

 print steps report, using the optional do_not_run flag to only include steps
 that have the flag in the indicated state.
   % workflow workflow_dir -s0 ON_DECK
   % workflow workflow_dir -s1 READY ON_DECK

 reset a workflow that died while running
   % workflow workflow_dir -r

";
    exit(1);
}
